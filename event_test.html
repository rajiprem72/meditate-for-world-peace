<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TEST MODE ‚Äî International Meditation Day</title>

<style>
  body { font-family: Arial, sans-serif; background:#f6f8fb; margin:0; }
  .wrap { max-width:900px; margin:25px auto; padding:20px; }

  h1 { text-align:center; color:#b22; }

  /* Player Container */
  .player-container {
    position: relative;
    width: 100%;
    height: 520px;
    overflow: hidden;
    border-radius: 12px;
    box-shadow:0 6px 20px rgba(0,0,0,0.12);
  }

  iframe {
    width: 100%;
    height: 100%;
    border: 0;
    display: block;
  }

  /* Blur Lock Overlay */
  .lock-overlay {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    backdrop-filter: blur(6px);
    background:rgba(0,0,0,0.45);
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:20px;
    font-size:20px;
    z-index:10;
  }

  .lock-overlay h2 {
    margin:0;
    font-size:28px;
  }

  .lock-overlay p {
    margin-top:10px;
    font-size:18px;
  }

  .timer-box {
    margin-top:20px;
    background:#fff;
    padding:15px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    font-size:20px;
    font-weight:bold;
    color:#b22;
    text-align:center;
  }

  input[type="text"] {
    padding:10px;
    width:100%;
    max-width:350px;
    border-radius:6px;
    border:1px solid #ccc;
    margin-top:8px;
  }

  button {
    margin-top:14px;
    padding:12px 15px;
    border-radius:8px;
    border:0;
    background:#4e46e5;
    color:#fff;
    cursor:pointer;
    font-size:16px;
  }

  button:disabled { opacity:0.6; cursor:not-allowed; }

  .success {
    margin-top:20px;
    background:#e6fff0;
    padding:12px;
    border-radius:8px;
    border:1px solid #bfe7c6;
    color:#0a6a36;
    display:none;
  }
</style>

</head>
<body>
<div class="wrap">

<h1>TEST MODE ‚Äî 30 Second Completion</h1>

<!-- PLAYER AREA -->
<div class="player-container">
  <iframe id="ytplayer"
    src="https://www.youtube-nocookie.com/embed/r1WuDMFKMpE?enablejsapi=1&rel=0&modestbranding=1"
    allow="autoplay; encrypted-media; picture-in-picture"
    allowfullscreen>
  </iframe>

  <!-- BLUR & LOCK OVERLAY -->
  <div id="lockOverlay" class="lock-overlay">
    <h2>‚è≥ Video Locked</h2>
    <p id="unlockText">Video will unlock soon‚Ä¶</p>
  </div>
</div>

<div class="timer-box" id="timerDisplay">00:30</div>

<!-- USER INPUT -->
<div style="margin-top:20px;">
  <label><strong>Your Registration ID</strong></label><br>
  <input type="text" id="regid" placeholder="GSY2025-xxxxxx">
</div>

<button id="submitBtn" disabled>Submit Completion</button>

<div id="result" class="success"></div>

<script>
// === CONFIGURATION ===
const REQUIRED_SECONDS = 30;

// üî• TEST MODE unlock time ‚Äî change for testing
const UNLOCK_HOUR = 21;   // 20 = 8 PM
const UNLOCK_MINUTE = 40; // :45

let watchedSeconds = 0;
let playing = false;
let intervalTick = null;

function formatTime(num){ return num.toString().padStart(2,'0'); }

// === Calculate today's unlock time ===
const now = new Date();
const unlockAt = new Date();
unlockAt.setHours(UNLOCK_HOUR, UNLOCK_MINUTE, 0, 0);

// Show unlock time to user
let hr = UNLOCK_HOUR % 12 || 12;
let ampm = UNLOCK_HOUR >= 12 ? "PM" : "AM";
document.getElementById("unlockText").innerHTML =
  `‚è≥ Video & Submission will unlock today at <br><b>${hr}:${formatTime(UNLOCK_MINUTE)} ${ampm}</b><br><br>
   Please keep your Registration ID safe.<br>
   You must enter it twice: here & in the Google Form.`;

// === Load YouTube API ===
let tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.head.appendChild(tag);

let player;
function onYouTubeIframeAPIReady() {
  player = new YT.Player('ytplayer', {
    events: { 'onStateChange': onPlayerStateChange }
  });
}

// === Disable player until unlock time ===
let unlocked = false;

function checkUnlock() {
  const now = new Date();
  if (now >= unlockAt) {
    unlocked = true;
    document.getElementById("lockOverlay").style.display = "none";
  }
}
setInterval(checkUnlock, 1000);
checkUnlock();

// === Player State Handler ===
function onPlayerStateChange(e) {

  if (!unlocked) {
    // Immediately stop the video
    if (player && player.pauseVideo) player.pauseVideo();

    alert("The meditation will start at the scheduled time.\nPlease wait until the unlocking time.");
    return;
  }

  // Start counting only when video plays
  if (e.data === 1) startCounting();
  else stopCounting();
}

function startCounting() {
  if (playing) return;
  playing = true;

  intervalTick = setInterval(() => {
    watchedSeconds++;
    updateTimer();

    if (watchedSeconds >= REQUIRED_SECONDS) {
      enableSubmission();
      stopCounting();
    }

  }, 1000);
}

function stopCounting() {
  if (!playing) return;
  playing = false;
  clearInterval(intervalTick);
}

function updateTimer() {
  const remain = Math.max(0, REQUIRED_SECONDS - watchedSeconds);
  const mm = formatTime(Math.floor(remain / 60));
  const ss = formatTime(remain % 60);
  document.getElementById('timerDisplay').textContent = `${mm}:${ss}`;
}

function enableSubmission() {
  document.getElementById('submitBtn').disabled = false;
  const r = document.getElementById('result');
  r.style.display = 'block';
  r.textContent = "‚úî You completed 30 seconds. You can now submit.";
}

// === Prefill URL ===
function getPrefillURL(regID) {
  return "https://docs.google.com/forms/d/e/1FAIpQLSdWArsVRMeGS-uT5KuhYTUExa1mjk5uS25nd-13F2QCsotcaw/viewform?"
       + "usp=pp_url&entry.1776124627=" + encodeURIComponent(regID);
}

// === Submit Handler ===
document.getElementById('submitBtn').addEventListener('click', function() {
  const regID = document.getElementById('regid').value.trim();

  if (!regID) return alert("Please enter your Registration ID");
  if (!/^GSY2025-/.test(regID)) return alert("Invalid Registration ID");

  window.location.href = getPrefillURL(regID);
});
</script>

</body>
</html>
